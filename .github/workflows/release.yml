# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# Raypher Release Pipeline ‚Äî The Factory
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# Triggered by pushing a version tag (e.g., v0.2.0).
# Builds for: Windows (binary + MSI), Linux AMD64, Linux ARM64.
# Generates SHA256 checksums for integrity verification.
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  # ‚îÄ‚îÄ Gate: Run tests before any builds ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Run tests
        run: cargo test --no-default-features

  # ‚îÄ‚îÄ Linux Builds (AMD64 + ARM64) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  build-linux:
    needs: test
    strategy:
      matrix:
        include:
          - target: x86_64-unknown-linux-gnu
            artifact: raypher-linux-amd64
          - target: aarch64-unknown-linux-gnu
            artifact: raypher-linux-arm64
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install cross-compilation toolchain
        run: cargo install cross --locked

      - name: Build
        run: cross build --release --target ${{ matrix.target }} --no-default-features

      - name: Prepare artifact
        run: |
          cp target/${{ matrix.target }}/release/raypher-core ${{ matrix.artifact }}
          chmod +x ${{ matrix.artifact }}

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: ${{ matrix.artifact }}

  # ‚îÄ‚îÄ Windows Build (Binary + MSI Installer) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  build-windows:
    needs: test
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable

      - name: Build release binary
        run: cargo build --release

      - name: Install cargo-wix
        run: cargo install cargo-wix --locked

      - name: Build MSI installer
        run: cargo wix --no-build --nocapture
        # --no-build because we already built above

      - name: Upload binary
        uses: actions/upload-artifact@v4
        with:
          name: raypher-windows.exe
          path: target/release/raypher-core.exe

      - name: Upload MSI
        uses: actions/upload-artifact@v4
        with:
          name: RaypherSetup.msi
          path: target/wix/*.msi

  # ‚îÄ‚îÄ Create GitHub Release ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  release:
    needs: [build-linux, build-windows]
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Generate SHA256 checksums
        run: |
          cd artifacts
          find . -type f \( -name "*.exe" -o -name "*.msi" -o -name "raypher-*" \) -exec sha256sum {} \; | sort > SHA256SUMS.txt
          echo "=== Checksums ==="
          cat SHA256SUMS.txt

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: Raypher ${{ github.ref_name }} ‚Äî Ghost Protocol
          body: |
            ## Raypher ${{ github.ref_name }} ‚Äî Ghost Protocol

            Silicon-native sovereign security for AI agents.

            ### Downloads

            | Platform | File | Notes |
            |---|---|---|
            | ü™ü Windows (Installer) | `RaypherSetup.msi` | **Recommended.** Double-click ‚Üí auto-installs as service. |
            | ü™ü Windows (Binary) | `raypher-windows.exe` | Manual / portable installation. |
            | üêß Linux (AMD64) | `raypher-linux-amd64` | For x86_64 servers and desktops. |
            | üêß Linux (ARM64) | `raypher-linux-arm64` | For Raspberry Pi, AWS Graviton, etc. |

            ### Verify Integrity
            ```bash
            sha256sum -c SHA256SUMS.txt
            ```

            ### Quick Start
            ```powershell
            # Windows (after MSI install)
            raypher-core scan
            raypher-core seal --provider openai --key "sk-..."
            raypher-core proxy

            # Linux
            chmod +x raypher-linux-amd64
            ./raypher-linux-amd64 scan
            ```
          files: |
            artifacts/**/*
            artifacts/SHA256SUMS.txt
          draft: false
          prerelease: false
