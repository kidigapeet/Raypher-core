<?xml version='1.0' encoding='utf-8'?>
<Wix xmlns="http://wixtoolset.org/schemas/v4/wxs"
     xmlns:util="http://wixtoolset.org/schemas/v4/wxs/util">

    <Package
        Name='Raypher AI Safety Agent'
        UpgradeCode='A1B2C3D4-E5F6-7890-ABCD-EF1234567890'
        Manufacturer='Raypher Labs'
        Language='1033'
        Version='$(var.Version)'
        InstallerVersion='450'>

        <MajorUpgrade
            Schedule='afterInstallInitialize'
            DowngradeErrorMessage='A newer version of [ProductName] is already installed. Setup will now exit.' />

        <MediaTemplate EmbedCab='yes' />

        <!-- ── Application Icon ── -->
        <Icon Id='RaypherIcon' SourceFile='assets\raypher_logo.ico' />
        <Property Id='ARPPRODUCTICON' Value='RaypherIcon' />

        <!-- ── Metadata (for Programs & Features) ── -->
        <Property Id='ARPHELPLINK' Value='https://github.com/kidigapeet/Raypher-core' />
        <Property Id='ARPURLINFOABOUT' Value='https://github.com/kidigapeet/Raypher-core' />

        <!-- ══════════════════════════════════════════════════════
             DIRECTORY STRUCTURE
             ══════════════════════════════════════════════════════ -->
        <StandardDirectory Id='ProgramFiles64Folder'>
            <Directory Id='APPLICATIONFOLDER' Name='Raypher'>
                <!-- Main binary -->
                <Component Id='binary0' Guid='*'>
                    <File
                        Id='exe0'
                        Name='raypher-core.exe'
                        DiskId='1'
                        Source='target\release\raypher-core.exe'
                        KeyPath='yes'>
                        
                        <!-- ── Advertised Start Menu Shortcut ── -->
                        <Shortcut
                            Id='ApplicationStartMenuShortcut'
                            Directory='ApplicationProgramsFolder'
                            Name='Raypher CLI'
                            Description='Raypher AI Safety Agent — Command Line Interface'
                            WorkingDirectory='APPLICATIONFOLDER'
                            Advertise='yes' />
                    </File>

                    <!-- ── Windows Service Registration ── -->
                    <ServiceInstall
                        Id='RaypherServiceInstall'
                        Name='RaypherService'
                        DisplayName='Raypher AI Safety Agent'
                        Description='Silicon-native sovereign security — monitors AI processes, manages API key vault, localhost proxy.'
                        Start='auto'
                        Type='ownProcess'
                        ErrorControl='normal'
                        Account='LocalSystem'
                        Arguments='--service' />

                    <!-- Start on install, stop on uninstall -->
                    <ServiceControl
                        Id='RaypherServiceControl'
                        Name='RaypherService'
                        Start='install'
                        Stop='both'
                        Remove='uninstall'
                        Wait='yes' />
                </Component>

                <!-- ── Add to PATH (Machine-wide) ── -->
                <Component Id='Path' Guid='*'>
                    <Environment
                        Id='PATH'
                        Name='PATH'
                        Value='[APPLICATIONFOLDER]'
                        Permanent='no'
                        Part='last'
                        Action='set'
                        System='yes' />
                    <RegistryValue
                        Root='HKLM'
                        Key='Software\Raypher Labs\Raypher'
                        Name='PathConfigured'
                        Type='integer'
                        Value='1'
                        KeyPath='yes' />
                </Component>
            </Directory>
        </StandardDirectory>

        <StandardDirectory Id='ProgramMenuFolder'>
            <Directory Id='ApplicationProgramsFolder' Name='Raypher'>
                <Component Id='CleanUpShortCut' Guid='*'>
                    <RemoveFolder Id='CleanUpShortCut' On='uninstall' />
                    <RegistryValue
                        Root='HKCU'
                        Key='Software\Raypher Labs\Raypher'
                        Name='ShortcutsCleaned'
                        Type='integer'
                        Value='1'
                        KeyPath='yes' />
                </Component>
            </Directory>
        </StandardDirectory>

        <StandardDirectory Id='DesktopFolder'>
            <Component Id='RaypherDesktopShortcut' Guid='*'>
                <Shortcut
                    Id='DesktopShortcut'
                    Name='Raypher'
                    Description='Raypher AI Safety Agent — Command Center Dashboard'
                    Target='[APPLICATIONFOLDER]raypher-core.exe'
                    Arguments='dashboard'
                    WorkingDirectory='APPLICATIONFOLDER'
                    Icon='RaypherIcon' />
                <RegistryValue
                    Root='HKCU'
                    Key='Software\Raypher Labs\Raypher'
                    Name='DesktopShortcutConfigured'
                    Type='integer'
                    Value='1'
                    KeyPath='yes' />
            </Component>
        </StandardDirectory>

        <!-- ══════════════════════════════════════════════════════
             FEATURE TREE
             ══════════════════════════════════════════════════════ -->
        <Feature
            Id='Main'
            Title='Raypher Application'
            Description='Installs Raypher binary, registers the Windows service, adds a Start Menu shortcut, and configures the system PATH.'
            Level='1'
            ConfigurableDirectory='APPLICATIONFOLDER'
            AllowAdvertise='no'>

            <ComponentRef Id='binary0' />
            <ComponentRef Id='Path' />
            <ComponentRef Id='CleanUpShortCut' />
            <ComponentRef Id='RaypherDesktopShortcut' />
        </Feature>

        <!-- ══════════════════════════════════════════════════════
             SILENT SETUP CUSTOM ACTION
             Runs `raypher-core.exe setup --silent` after files are
             placed on disk. Runs only on fresh installs (NOT Installed).
             Execute='deferred' + Impersonate='no' gives LocalSystem
             privileges needed for CA trust store + env var writes.
             ══════════════════════════════════════════════════════ -->
        <CustomAction Id='RunSetup'
            Directory='APPLICATIONFOLDER'
            ExeCommand='[APPLICATIONFOLDER]raypher-core.exe setup --silent'
            Execute='deferred'
            Impersonate='no'
            Return='ignore' />

        <InstallExecuteSequence>
            <Custom Action='RunSetup' After='InstallFiles'>NOT Installed</Custom>
        </InstallExecuteSequence>

    </Package>
</Wix>
